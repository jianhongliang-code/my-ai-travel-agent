<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Travel Guide - Live Stream Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card.active {
            border-left: 5px solid #007bff;
            transform: translateX(10px);
        }
        h1 { color: #333; }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            background-color: #6c757d;
        }
        .status-processing { background-color: #007bff; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        
        #log-container {
            background: #2d2d2d;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <h1>ğŸš€ Omni Travel Guide: Agent Stream</h1>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨ LangGraph å¤šæ™ºèƒ½ä½“åä½œæµã€‚</p>
    
    <button id="startBtn" onclick="startStream()">å¼€å§‹è¡Œç¨‹è§„åˆ’ (Start Stream)</button>
    <div id="status" style="margin-top: 10px; color: #666;"></div>

    <div id="cards-container">
        <!-- Agent cards will appear here -->
        <div id="card-planner" class="card" style="opacity: 0.5;">
            <h3>ğŸ—ºï¸ AI Planner (ç­–åˆ’å¸ˆ)</h3>
            <p id="planner-content">ç­‰å¾…ä»»åŠ¡...</p>
        </div>

        <div id="card-auditor" class="card" style="opacity: 0.5;">
            <h3>ğŸ” Auditor (å®¡è®¡å‘˜)</h3>
            <p id="auditor-content">ç­‰å¾…è¡Œç¨‹è‰æ¡ˆ...</p>
        </div>

        <div id="card-arbiter" class="card" style="opacity: 0.5;">
            <h3>âš–ï¸ Commercial Arbiter (å•†ä¸šåšå¼ˆ)</h3>
            <p id="arbiter-content">ç­‰å¾…å®¡è®¡ç»“æœ...</p>
        </div>
    </div>

    <h3>å®æ—¶æ—¥å¿— (SSE Data):</h3>
    <div id="control-panel" style="margin-top: 20px; display: none;">
        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba;">
            <strong>âš ï¸ å¾…å®¡æ‰¹ (Human-in-the-loop)</strong><br>
            Commercial Arbiter éœ€è¦ç¡®è®¤é¢„ç®—ç­–ç•¥ã€‚
            <br><br>
            <button onclick="approveTrip()" style="background: #28a745;">âœ… æ‰¹å‡†å¹¶ç»§ç»­</button>
        </div>
    </div>
    
    <div id="log-container"></div>

    <script>
        const userId = "user_" + Math.floor(Math.random() * 10000); // Random user ID for demo

        function log(message) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateCard(id, content, active=true) {
            const card = document.getElementById(`card-${id}`);
            const contentEl = document.getElementById(`${id}-content`);
            if (card && contentEl) {
                card.style.opacity = '1';
                if (active) card.classList.add('active');
                else card.classList.remove('active');
                
                // Remove active class from others to show flow
                document.querySelectorAll('.card').forEach(c => {
                    if (c.id !== `card-${id}`) c.classList.remove('active');
                });
                
                contentEl.innerHTML = content;
            }
        }

        function approveTrip() {
            log("Sending approval...");
            document.getElementById('control-panel').style.display = 'none';
            
            fetch(`http://localhost:8000/approve-trip/${userId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    log("Approved! Final State Received.");
                    console.log(data);
                    
                    // Manually update the last card since the stream ended
                    if (data.final_state && data.final_state.profit_margin) {
                         updateCard('arbiter', `
                                <strong>æœ€ç»ˆå†³ç­– (Approved)ï¼š</strong><br>
                                ğŸ’° åˆ©æ¶¦ç‡: ${data.final_state.profit_margin}%<br>
                                ğŸ¨ å®¡ç¾åˆ†: ${data.final_state.aesthetic_score}
                            `);
                         document.getElementById('status').textContent = "è§„åˆ’å®Œæˆ âœ… (Resumed)";
                         document.getElementById('startBtn').disabled = false;
                         document.getElementById('startBtn').textContent = "å¼€å§‹æ–°è§„åˆ’";
                    }
                })
                .catch(err => log("Approval failed: " + err));
        }

        function startStream() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = "æ­£åœ¨è§„åˆ’ä¸­...";
            document.getElementById('status').textContent = "è¿æ¥ SSE æµ...";
            document.getElementById('control-panel').style.display = 'none';
            
            // Reset UI
            document.querySelectorAll('.card').forEach(c => {
                c.style.opacity = '0.5';
                c.classList.remove('active');
            });
            document.getElementById('log-container').innerHTML = '';

            // Connect to FastAPI SSE endpoint
            const eventSource = new EventSource(`http://localhost:8000/stream-trip/${userId}`);

            eventSource.onopen = () => {
                log(`Connection opened (Thread ID: ${userId})`);
                document.getElementById('status').textContent = "æµå·²å»ºç«‹ï¼Œç­‰å¾… Agent å“åº”...";
            };

            eventSource.onmessage = (event) => {
                const rawData = event.data;
                log("Received: " + rawData);
                
                try {
                    const payload = JSON.parse(rawData);
                    
                    if (payload.node === 'EOF') {
                        log("Stream finished.");
                        eventSource.close();
                        btn.disabled = false;
                        btn.textContent = "å¼€å§‹è¡Œç¨‹è§„åˆ’ (Start Stream)";
                        document.getElementById('status').textContent = "è§„åˆ’å®Œæˆ âœ…";
                        return;
                    }
                    
                    if (payload.node === 'human_interrupt') {
                        log("â¸ï¸ Suspended for Human Input.");
                        eventSource.close();
                        document.getElementById('status').textContent = "ç­‰å¾…å®¡æ‰¹ â¸ï¸";
                        document.getElementById('control-panel').style.display = 'block';
                        return;
                    }

                    // Handle different nodes
                    switch(payload.node) {
                        case 'planner':
                            let listHtml = '<ul>' + payload.data.itinerary.map(i => `<li>${i}</li>`).join('') + '</ul>';
                            updateCard('planner', `<strong>è¡Œç¨‹è‰æ¡ˆç”Ÿæˆå®Œæ¯•ï¼š</strong>${listHtml}`);
                            break;
                            
                        case 'auditor':
                            let errorHtml = payload.data.errors.length > 0 
                                ? `<span style="color:red">âš ï¸ å‘ç°å†²çª: ${payload.data.errors.join(', ')}</span>`
                                : `<span style="color:green">âœ… è·¯çº¿é€šç•…ï¼Œæ— é£é™©ã€‚</span>`;
                            updateCard('auditor', errorHtml);
                            break;
                            
                        case 'commercial_arbiter':
                            updateCard('arbiter', `
                                <strong>æœ€ç»ˆå†³ç­–ï¼š</strong><br>
                                ğŸ’° åˆ©æ¶¦ç‡: ${payload.data.profit_margin}%<br>
                                ğŸ¨ å®¡ç¾åˆ†: ${payload.data.aesthetic_score}
                            `);
                            break;
                    }

                } catch (e) {
                    console.error("Error parsing JSON", e);
                    log("Error parsing JSON: " + e.message);
                }
            };

            eventSource.onerror = (err) => {
                console.error("Stream failed:", err);
                log("Stream error (check console). Is backend running?");
                eventSource.close();
                btn.disabled = false;
                btn.textContent = "é‡è¯•";
                document.getElementById('status').textContent = "è¿æ¥æ–­å¼€ âŒ (è¯·ç¡®ä¿ backend_api.py å·²è¿è¡Œ)";
            };
        }
    </script>
</body>
</html>
